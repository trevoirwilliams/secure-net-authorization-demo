# Security Vulnerability: Insecure Direct Object Reference (IDOR)

## Overview

The Task Details feature (`/TaskDetails/{id}`) contains an **Insecure Direct Object Reference (IDOR)** vulnerability, which is part of **OWASP A01:2021 - Broken Access Control**.

## The Vulnerability

### What's Wrong?

The `TaskDetails.cshtml.cs` page retrieves and displays task information based solely on the task ID in the URL, **without verifying** that the current user is authorized to view that task.

### Vulnerable Code

```csharp
public async Task<IActionResult> OnGetAsync(int id)
{
    TaskId = id;
    
    // VULNERABILITY: No authorization check!
    // We're fetching the task by ID without verifying the current user owns it.
    Task = await _repository.GetTaskByIdAsync(id);
    
    // ... rest of the code
}
```

## How to Exploit

1. **Log in as Alice** (alice@demo.local)
2. Navigate to **My Tasks** and view one of Alice's tasks (e.g., `/TaskDetails/1`)
3. Note the URL pattern: `/TaskDetails/{id}`
4. **Change the ID** in the URL to view Bob's tasks:
   - Try `/TaskDetails/4` (Bob's "Review security patches" task)
   - Try `/TaskDetails/5` (Bob's "Update firewall rules" task)
   - Try `/TaskDetails/6` (Bob's "Backup production database" task)

Alice can now see Bob's private tasks, even though she shouldn't have access!

## Demo User Task IDs

Based on the seed data:

**Alice's Tasks (alice@demo.local):**
- Task ID 1: "Complete project documentation"
- Task ID 2: "Review code changes"
- Task ID 3: "Update user manual"

**Bob's Tasks (bob@demo.local):**
- Task ID 4: "Review security patches"
- Task ID 5: "Update firewall rules"
- Task ID 6: "Backup production database"

**Charlie's Tasks (charlie@demo.local):**
- Task ID 7: "Design new feature"
- Task ID 8: "Create wireframes"
- Task ID 9: "User research interviews"

## Impact

This vulnerability allows:
- **Horizontal Privilege Escalation**: Users can access other users' data at the same privilege level
- **Information Disclosure**: Sensitive task information is exposed to unauthorized users
- **Privacy Breach**: Users' work activities and priorities are visible to others

## Detection

The application includes a built-in warning system. When a user views a task that doesn't belong to them, the page displays:

```
⚠️ Security Vulnerability Detected

Broken Access Control (OWASP A01:2021)
You are viewing a task that doesn't belong to you! This is an Insecure Direct Object Reference (IDOR) vulnerability.
The application does not verify that the current user owns this task before displaying it.
```

Additionally, the application logs the security violation:

```
SECURITY: User {CurrentUserId} ({Email}) accessed task {TaskId} owned by {OwnerId}
```

## How to Fix

This vulnerability will be fixed in a later lesson. The correct implementation should:

1. **Verify Ownership**: Check that the task's `OwnerUserId` matches the current user's ID
2. **Return 403 Forbidden**: If the user doesn't own the task, deny access
3. **Log Security Events**: Track unauthorized access attempts

### Secure Implementation (Example)

```csharp
public async Task<IActionResult> OnGetAsync(int id)
{
    TaskId = id;
    Task = await _repository.GetTaskByIdAsync(id);
    
    if (Task == null)
    {
        return NotFound();
    }
    
    // SECURE: Verify the current user owns this task
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    if (Task.OwnerUserId != currentUserId)
    {
        _logger.LogWarning(
            "Unauthorized access attempt: User {UserId} tried to access task {TaskId} owned by {OwnerId}",
            currentUserId, id, Task.OwnerUserId
        );
        return Forbid(); // Return 403 Forbidden
    }
    
    return Page();
}
```

## Learning Objectives

Students should understand:

1. **Why this is dangerous**: Direct object references (IDs) in URLs are predictable
2. **Authorization vs Authentication**: Being logged in (authenticated) doesn't mean you can access everything
3. **Least Privilege Principle**: Users should only access data they own or are authorized to see
4. **Defense in Depth**: Multiple layers of security checks are important

## Testing Instructions

### Test 1: View Your Own Task (Valid)
1. Log in as Alice
2. Navigate to My Tasks
3. Click "View Details" on any task
4. ✅ Should display the task without warnings

### Test 2: View Another User's Task (Exploit)
1. While logged in as Alice, note a task ID from your list (e.g., 1)
2. Manually change the URL to `/TaskDetails/4` (Bob's task)
3. ⚠️ Should display Bob's task with a security warning
4. Check the console logs for the security violation message

### Test 3: Cross-User Access
1. Log in as Bob (bob@demo.local)
2. Try to access `/TaskDetails/1` (Alice's task)
3. ⚠️ Should be able to see Alice's task

## Related Vulnerabilities

This is similar to other Broken Access Control vulnerabilities:
- **Direct File Access**: `/files/user123/document.pdf` → Change to `/files/user456/document.pdf`
- **API Endpoints**: `/api/users/123/profile` → Change to `/api/users/456/profile`
- **Database IDs**: Sequential or predictable identifiers make enumeration easy

## References

- [OWASP Top 10 2021 - A01:2021 Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [CWE-639: Authorization Bypass Through User-Controlled Key](https://cwe.mitre.org/data/definitions/639.html)
- [OWASP IDOR Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html)
